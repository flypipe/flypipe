<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Flypipe</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">


  <!-- Amsify Plugin -->
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
  <script type="text/javascript" src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
  <style>.amsify-suggestags-area
.amsify-suggestags-input-area-default {
	cursor: pointer;
    border: 1px solid #cccccc;
    min-height: 20px;
    padding: 8px 5px;
}

.amsify-suggestags-area
.amsify-suggestags-input-area {
	text-align: left;
	height: auto;
}

.amsify-suggestags-area
.amsify-suggestags-input-area:hover {
	cursor: text;
}

.amsify-suggestags-area
.amsify-suggestags-input-area
.amsify-suggestags-input {
	max-width: 200px;
	padding: 0px 4px;
	border: 0;
}

.amsify-suggestags-area
.amsify-suggestags-input-area
.amsify-suggestags-input:focus {
	outline: 0;
}

.amsify-focus {
	border-color: #66afe9;
	outline: 0;
	-webkit-box-shadow: inset 0 1px 1px rgba(0,0,0,.075), 0 0 8px rgba(102,175,233,.6);
	box-shadow: inset 0 1px 1px rgba(0,0,0,.075), 0 0 8px rgba(102,175,233,.6);
}

.amsify-focus-light {
	border-color: #cacaca;
	outline: 0;
	-webkit-box-shadow: inset 0 1px 1px rgba(0,0,0,.075), 0 0 8px rgba(189, 189, 189, 0.6);
	box-shadow: inset 0 1px 1px rgba(0,0,0,.075), 0 0 8px rgba(189, 189, 189, 0.6);
}

.amsify-suggestags-area
.amsify-suggestags-label {
	cursor: pointer;
	min-height: 20px;
}

.amsify-toggle-suggestags {
	float: right;
	cursor: pointer;
}

.amsify-suggestags-area .amsify-suggestags-list {
	display: none;
	position: absolute;
	background: white;
	border: 1px solid #dedede;
	z-index: 1;
}

.amsify-suggestags-area
.amsify-suggestags-list
ul.amsify-list {
	list-style: none;
	padding: 3px 0px;
	max-height: 150px;
    overflow-y: auto;
}

.amsify-suggestags-area
.amsify-suggestags-list
ul.amsify-list
li.amsify-list-item {
	text-align: left;
    cursor: pointer;
    padding: 0px 10px;	
}

.amsify-suggestags-area
.amsify-suggestags-list
ul.amsify-list
li.amsify-list-item:active {
	background: #717171;
    color: white;
    -moz-box-shadow:    inset 0 0 10px #000000;
    -webkit-box-shadow: inset 0 0 10px #000000;
    box-shadow:         inset 0 0 10px #000000;
}

.amsify-suggestags-area
.amsify-suggestags-list
ul.amsify-list
li.amsify-list-group {
	text-align: left;
    padding: 0px 10px;
    font-weight: bold;
}

.amsify-suggestags-area
.amsify-suggestags-list
ul.amsify-list
li.amsify-item-pad {
    padding-left: 30px;
}

.amsify-suggestags-area
.amsify-suggestags-list
ul.amsify-list
li.amsify-item-noresult {
    display: none;
    color: #ff6060;
    font-weight: bold;
    text-align: center;
}

.amsify-suggestags-area
.amsify-suggestags-list
.amsify-select-input {
	display: none;
}

.amsify-suggestags-area
.amsify-suggestags-list
ul.amsify-list
li.active {
	background: #d9d8d8;
}

.amsify-suggestags-area
.amsify-suggestags-list
ul.amsify-list
li.amsify-item-pad.active {
	font-weight: normal;
}

.amsify-suggestags-input-area
.amsify-select-tag,
.amsify-suggestags-input-area
.amsify-plus-tag {
    padding: 2px 7px;
    margin: 0px 4px 1px 0px;
    -webkit-border-radius: 2px;
    -moz-border-radius: 2px;
    border-radius: 2px;
    display: inline-block;
}

.amsify-suggestags-input-area
.amsify-select-tag.col-bg {
	background: #d8d8d8;
    color: black;
}

.amsify-suggestags-input-area
.amsify-plus-tag.show-plus-bg {
	background: #767676;
    color: white;
    -webkit-border-radius: 15px;
    -moz-border-radius: 15px;
    border-radius: 15px;
}

/*.amsify-suggestags-input-area
.amsify-select-tag:hover {
	background: #737373;
    color: white;
}*/

.amsify-suggestags-input-area
.disabled.amsify-select-tag {
    background: #eaeaea;
    color: #b9b9b9;
    pointer-events: none;
}

.amsify-suggestags-input-area
.flash.amsify-select-tag {
    background-color: #f57f7f;
    -webkit-transition: background-color 200ms linear;
    -ms-transition: background-color 200ms linear;
    transition: background-color 200ms linear;
}

.amsify-suggestags-input-area
.amsify-remove-tag {
	cursor: pointer;
}

.amsify-no-suggestion {
	display: none;
	opacity: 0.7;
}</style>
  <script>/**
 * Amsify Suggestags
 * https://github.com/amsify42/jquery.amsify.suggestags
 */

var AmsifySuggestags;

(function(factory) {
	if(typeof module === 'object' && typeof module.exports === 'object') {
		factory(require('jquery'), window, document);
	} else {
		factory(jQuery, window, document);
	}
}
(function($, window, document, undefined) {
	
	AmsifySuggestags = function(selector) {
		this.selector = selector;
		this.settings = {
			type              : 'bootstrap',
			tagLimit          : -1,
			suggestions       : [],
			suggestMatch 	  : {},
			suggestionsAction : {timeout: -1, minChars:2, minChange:-1, delay:100, type: 'GET'},
			defaultTagClass   : '',
			classes           : [],
			backgrounds       : [],
			colors            : [],
			whiteList         : false,
			afterAdd          : {},
			afterRemove       : {},
			//My changes
			trimValue         : false,
			dashspaces        : false,
			lowercase         : false,
			selectOnHover     : true,
			triggerChange     : false,
			noSuggestionMsg   : '',
			showAllSuggestions: false,
			keepLastOnHoverTag: true,
			printValues 	  : true,
			checkSimilar 	  : true,
			delimiters 		  : [],
			showPlusAfter 	  : 0,
			callbacks         : undefined
		};
		this.method        = undefined;
		this.name          = null;
		this.defaultLabel  = 'Filter tag';
		this.classes       = {
			sTagsArea     : '.amsify-suggestags-area',
			inputArea     : '.amsify-suggestags-input-area',
			inputAreaDef  : '.amsify-suggestags-input-area-default',
			focus         : '.amsify-focus',
			sTagsInput    : '.amsify-suggestags-input',
			listArea      : '.amsify-suggestags-list',
			list          : '.amsify-list',
			listItem      : '.amsify-list-item',
			itemPad       : '.amsify-item-pad',
			inputType     : '.amsify-select-input',
			tagItem       : '.amsify-select-tag',
			plusItem 	  : '.amsify-plus-tag',
			colBg         : '.col-bg',
			removeTag     : '.amsify-remove-tag',
			readyToRemove : '.ready-to-remove',
			noSuggestion  : '.amsify-no-suggestion',
			showPlusBg 	  : '.show-plus-bg'
		};
		this.selectors     = {
			sTagsArea     : null,
			inputArea     : null,
			inputAreaDef  : null,
			sTagsInput    : null,
			listArea      : null,
			list          : null,
			listGroup     : null,
			listItem      : null,
			itemPad       : null,
			inputType     : null,
			plusTag 	  : null
		};
		this.isRequired = false;
		this.ajaxActive = false; 
		this.tagNames   = [];
		this.delayTimer = 0;
		this.blurTgItems= null;
	};
	AmsifySuggestags.prototype = {
	   /**
		* Merging default settings with custom
		* @type {object}
		*/
		_settings : function(settings) {
			this.settings = $.extend(true, {}, this.settings, settings);      
		},

		_setMethod : function(method) {
			this.method = method;
		},

		_init : function() {
			if(this.checkMethod()) {
				this.name = ($(this.selector).attr('name'))? $(this.selector).attr('name')+'_amsify': 'amsify_suggestags';
				this.createHTML();
				this.setEvents();
				$(this.selector).hide();
				this.setDefault();
			}
		},

		createHTML : function() {
			var HTML                  = '<div class="'+this.classes.sTagsArea.substring(1)+'"></div>';
			this.selectors.sTagsArea  = $(HTML).insertAfter(this.selector);
			var labelHTML             = '<div class="'+this.classes.inputArea.substring(1)+'"></div>';
			this.selectors.inputArea  = $(labelHTML).appendTo(this.selectors.sTagsArea);
			this.defaultLabel         = ($(this.selector).attr('placeholder') !== undefined)? $(this.selector).attr('placeholder'): this.defaultLabel;
			var sTagsInput            = '<input type="text" class="'+this.classes.sTagsInput.substring(1)+'" placeholder="'+this.defaultLabel+'">';
			this.selectors.sTagsInput = $(sTagsInput).appendTo(this.selectors.inputArea).attr('autocomplete', 'off');
			if($(this.selector).attr('required')) {
				$(this.selector).removeAttr('required');
				this.isRequired = true;
				this.updateIsRequired();
			}
			var listArea              = '<div class="'+this.classes.listArea.substring(1)+'"></div>';
			this.selectors.listArea   = $(listArea).appendTo(this.selectors.sTagsArea);
			$(this.selectors.listArea).width($(this.selectors.sTagsArea).width()-3);
			var list                  = '<ul class="'+this.classes.list.substring(1)+'"></ul>';
			this.selectors.list       = $(list).appendTo(this.selectors.listArea);
			this.updateSuggestionList();
			this.fixCSS();
		},

		updateIsRequired : function() {
			if(this.isRequired) {
				if(this.tagNames.length){
					$(this.selectors.sTagsInput).removeAttr('required');
				} else {
					$(this.selectors.sTagsInput).attr('required', 'required');
				}
			}
		},

		updateSuggestionList : function() {
			$(this.selectors.list).html('');
			$(this.createList()).appendTo(this.selectors.list);
		},

		setEvents : function() {
			var _self = this;
			$(this.selectors.inputArea).attr('style', $(this.selector).attr('style')).addClass($(this.selector).attr('class'));
			this.setTagEvents();
			if(window !== undefined) {
				$(window).resize(function(){
					$(_self.selectors.listArea).width($(_self.selectors.sTagsArea).width()-3);
				});
			}
			this.setSuggestionsEvents();
			this.setRemoveEvent();
		},

		setTagEvents : function() {
			var _self = this;
			$(this.selectors.sTagsInput).focus(function(){
			   /**
				* Show all suggestions if setting set to true
				*/
				if(_self.settings.showAllSuggestions) {
					_self.suggestWhiteList('', 0, true);
				}
				$(this).closest(_self.classes.inputArea).addClass(_self.classes.focus.substring(1));
				if(_self.settings.type == 'materialize') {
					$(this).css({
						'border-bottom': 'none',
						'-webkit-box-shadow': 'none',
						'box-shadow': 'none',
					});
				}
				_self.checkPlusAfter();
			});
			$(this.selectors.sTagsInput).blur(function(){
				$(this).closest(_self.classes.inputArea).removeClass(_self.classes.focus.substring(1));
				if(!$(this).val()) {
					$(_self.selectors.listArea).hide();
				}
				_self.checkPlusAfter(true);
			});
			$(this.selectors.sTagsInput).keyup(function(e){
				var keycode = (e.keyCode ? e.keyCode : e.which);
				var key 	= '';
				if(e.key) {
					key = e.key;
				} else {
					if(keycode == '13') {
						key = 'Enter';
					} else if(keycode == '188') {
						key = ',';
					}
				}
				/**
				 * Mobile browser fix
				 */
				if(keycode == 229 && key == 'Unidentified' && /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(navigator.userAgent.toLowerCase()) && $(this).val()[$(this).val().length - 1] == ',')
				{
					key = ',';
				}
				var isDelimiter = ($.inArray(key, _self.settings.delimiters) !== -1)? true: false;
				if(key == 'Enter' || key == ',' || isDelimiter) {
					var value = $.trim($(this).val().replace(/,/g , ''));
					if(isDelimiter) {
						$.each(_self.settings.delimiters, function(dkey, delimiter) {
							value = $.trim(value.replace(delimiter, ''));
						});
					}
					$(this).val('');
					_self.addTag(_self.getValue(value));
					if(_self.settings.showAllSuggestions) {
						_self.suggestWhiteList('', 0, true);
					}
				} else if(keycode == '8' && !$(this).val()) {
					var removeClass = _self.classes.readyToRemove.substring(1);
					if($(this).hasClass(removeClass)) {
						$item = $(this).closest(_self.classes.inputArea).find(_self.classes.tagItem+':last');
						_self.removeTagByItem($item, false);
					} else {
						$(this).addClass(removeClass);
					}
					$(_self.selectors.listArea).hide();
					if(_self.settings.showAllSuggestions) {
						_self.suggestWhiteList('', 0, true);
					}
				} else if((_self.settings.suggestions.length || _self.isSuggestAction()) && ($(this).val() || _self.settings.showAllSuggestions)) {
					$(this).removeClass(_self.classes.readyToRemove.substring(1));
					_self.processWhiteList(keycode, $(this).val());
				}
			});
			$(this.selectors.sTagsInput).keypress(function(e){
				var keycode = (e.keyCode ? e.keyCode : e.which);
				if(keycode == 13) {
					return false;
				}
			});
			$(this.selectors.sTagsArea).click(function(){
				$(_self.selectors.sTagsInput).focus();
			});
		},

		setSuggestionsEvents : function() {
			var _self = this;
			if(this.settings.selectOnHover) {
				$(this.selectors.listArea).find(this.classes.listItem).hover(function(){
					$(_self.selectors.listArea).find(_self.classes.listItem).removeClass('active');
					$(this).addClass('active');
					$(_self.selectors.sTagsInput).val($(this).text());
				}, function() {
					$(this).removeClass('active');
					if(!_self.settings.keepLastOnHoverTag) {
						$(_self.selectors.sTagsInput).val('');
					}
				});
			}
			$(this.selectors.listArea).find(this.classes.listItem).click(function(){
				_self.addTag($(this).data('val'));
				$(_self.selectors.sTagsInput).val('').focus();
			});
		},

		isSuggestAction : function() {
			return (this.settings.suggestionsAction && this.settings.suggestionsAction.url);
		},

		getTag : function(value) {
			if(this.settings.suggestions.length) {
				var tag = value;
				$.each(this.settings.suggestions, function(key, item){
					if(typeof item === 'object' && item.value == value) {
						tag = item.tag
						return false;
					}
					else if(item == value) {
						return false; 
					}
				});
				return tag;
			}
			return value;
		},

		getValue : function(tag) {
			if(this.settings.suggestions.length) {
				var value = tag;
				var lower = tag.toString().toLowerCase();
				$.each(this.settings.suggestions, function(key, item){
					if(typeof item === 'object' && item.tag.toString().toLowerCase() == lower) {
						value = item.value
						return false;
					}
					else if(item.toString().toLowerCase() == lower) {
						return false; 
					}
				});
				return value;
			}
			return tag;
		},

		processAjaxSuggestion : function(value, keycode) {
			var _self           = this;
			var actionURL    	= this.getActionURL(this.settings.suggestionsAction.url);
			var params          = {existingTags: this.tagNames, existing: this.settings.suggestions, term: value};
			var ajaxConfig      = (this.settings.suggestionsAction.callbacks)? this.settings.suggestionsAction.callbacks: {};
			var ajaxFormParams  = {
				url : actionURL,
			};
			if(this.settings.suggestionsAction.type == 'GET') {
				ajaxFormParams.url = ajaxFormParams.url+'?'+$.param(params);
			} else {
				ajaxFormParams.type = this.settings.suggestionsAction.type;
				ajaxFormParams.data = params;
			}
			if(this.settings.suggestionsAction.timeout !== -1) {
				ajaxFormParams['timeout'] = this.settings.suggestionsAction.timeout*1000;
			}
			if(this.settings.suggestionsAction.beforeSend !== undefined && typeof this.settings.suggestionsAction.beforeSend == "function") {
				ajaxFormParams['beforeSend'] = this.settings.suggestionsAction.beforeSend;
			}
			ajaxFormParams['success'] = function(data) {
				if(data && data.suggestions) {
					_self.settings.suggestions = $.merge(_self.settings.suggestions, data.suggestions);
					_self.settings.suggestions = _self.unique(_self.settings.suggestions);
					_self.updateSuggestionList();
					_self.setSuggestionsEvents();
					_self.suggestWhiteList(value, keycode);
				}
				if(_self.settings.suggestionsAction.success !== undefined && typeof _self.settings.suggestionsAction.success == "function") {
					_self.settings.suggestionsAction.success(data);
				}
			};
			if(this.settings.suggestionsAction.error !== undefined && typeof this.settings.suggestionsAction.error == "function") {
				ajaxFormParams['error'] = this.settings.suggestionsAction.error;
			}
			ajaxFormParams['complete'] = function(data) {
				if(_self.settings.suggestionsAction.complete !== undefined && typeof _self.settings.suggestionsAction.complete == "function") {
					_self.settings.suggestionsAction.complete(data);
				}
				_self.ajaxActive = false;
			};

			if(this.settings.suggestionsAction.dataType !== undefined && this.settings.suggestionsAction.dataType !== null) {
                ajaxFormParams['dataType'] = this.settings.suggestionsAction.dataType;
            }

			$.ajax(ajaxFormParams);
		},

		processWhiteList : function(keycode, value) {
			if(keycode == '40' || keycode == '38') {
				var type = (keycode == '40')? 'down': 'up';
				this.upDownSuggestion(value, type);
			} else {
				clearTimeout(this.delayTimer);
				var _self       = this;
				this.delayTimer = setTimeout(function() {
					if(_self.isSuggestAction() && !_self.ajaxActive) {
				      	var minChars  = _self.settings.suggestionsAction.minChars;
						var minChange = _self.settings.suggestionsAction.minChange;
						var lastSearch= _self.selectors.sTagsInput.attr('last-search');
						if(value.length >= minChars && (minChange === -1 || !lastSearch || _self.similarity(lastSearch, value)*100 <= minChange)) {
							_self.selectors.sTagsInput.attr('last-search', value);
							_self.ajaxActive = true;
							_self.processAjaxSuggestion(value, keycode);
						}
					} else {
						_self.suggestWhiteList(value, keycode);
					}
			    }, this.settings.suggestionsAction.delay);
			}
		},

		upDownSuggestion : function(value, type) {
			var _self     = this;
			var isActive  = false;
			$(this.selectors.listArea).find(this.classes.listItem+':visible').each(function(){
				if($(this).hasClass('active')) {
					$(this).removeClass('active');
					if(type == 'up') {
						$item = $(this).prevAll(_self.classes.listItem+':visible:first');
					} else {
						$item = $(this).nextAll(_self.classes.listItem+':visible:first');
					}
					if($item.length) {
						isActive = true;
						$item.addClass('active');
						$(_self.selectors.sTagsInput).val($item.text());
					}
					return false;
				}
			});
			if(!isActive) {
				var childItem = (type == 'down')? 'first': 'last';
				$item = $(this.selectors.listArea).find(this.classes.listItem+':visible:'+childItem);
				if($item.length) {
					$item.addClass('active');
					$(_self.selectors.sTagsInput).val($item.text());
				}
			}
		},

		suggestWhiteList : function(value, keycode, showAll) {
			var _self = this;
			var found = false;
			var all   = (showAll)? true: false;
			var lower = value.toString().toLowerCase();
			$(this.selectors.listArea).find(_self.classes.noSuggestion).hide();
			var $list = $(this.selectors.listArea).find(this.classes.list);
			$list.find(this.classes.listItem).each(function(){
				var dataVal = $(this).data('val');
				if($.isNumeric(dataVal)) {
					dataVal = (value.toString().indexOf('.') == -1)? parseInt(dataVal): parseFloat(dataVal);
				}

				/**
				 * Suggest item matching result
				 */
				var suggestItemResult = 0;
				if(_self.settings.suggestMatch && typeof _self.settings.suggestMatch == "function") {
					suggestItemResult = _self.settings.suggestMatch($(this).text(), value);
				} else {
					suggestItemResult = ~$(this).text().toString().toLowerCase().indexOf(lower);
				}

				if((all || suggestItemResult) && $.inArray(dataVal, _self.tagNames) === -1) {
					$(this).attr('data-show', 1);
					found = true;
				} else {
					$(this).removeAttr('data-show');
				}
				$(this).hide();
			});
			if(found) {
				/**
				 * Sorting the suggestions
				 */
				$dataShow = $list.find(this.classes.listItem+'[data-show]');
				if(lower) {
					$dataShow.sort(function(a, b) {
						return value.localeCompare($(a).text().toString());
					}).appendTo($list);
				} else {
					$dataShow.sort(function(a, b) {
						return $(a).text().toString().localeCompare($(b).text().toString());
					}).appendTo($list);
				}
				$dataShow.each(function(){
					$(this).show();
				});

			   /**
				* If only one item left in whitelist suggestions
				*/
				$item = $(this.selectors.listArea).find(this.classes.listItem+':visible');
				if($item.length == 1 && keycode != '8') {
					if((this.settings.whiteList && this.isSimilarText(value.toLowerCase(), $item.text().toLowerCase(), 40)) || this.isSimilarText(value.toLowerCase(), $item.text().toLowerCase(), 60)) {
						$item.addClass('active');
						$(this.selectors.sTagsInput).val($item.text());
					}
				} else {
					$item.removeClass('active');
				}

				$(this.selectors.listArea).show();

			} else {
				if(value && _self.settings.noSuggestionMsg) {
					$(this.selectors.listArea).find(_self.classes.listItem).hide();
					$(this.selectors.listArea).find(_self.classes.noSuggestion).show();
				} else {
					$(this.selectors.listArea).hide();
				}
			}
		},

		setDefault : function() {
			var _self = this;
			var items = $(this.selector).val().split(',');
			if(items.length) {
				$.each(items, function(index, item){
					_self.addTag($.trim(item));
				});
			}
		},

		setRemoveEvent: function() {
			var _self = this;
			$(this.selectors.inputArea).find(this.classes.removeTag).click(function(e){
				e.stopImmediatePropagation();
				$tagItem = $(this).closest(_self.classes.tagItem);
				_self.removeTagByItem($tagItem, false);
			});
		},

		createList : function() {
			var _self     = this;
			var listHTML  = '';
			$.each(this.settings.suggestions, function(index, item){
				var value = '';
				var tag   = '';
				if(typeof item === 'object') {
					value = item.value
					tag   = item.tag
				} else {
					value = item;
					tag   = item;
				}
				listHTML += '<li class="'+_self.classes.listItem.substring(1)+'" data-val="'+value+'">'+tag+'</li>';
			});
			if(_self.settings.noSuggestionMsg) {
				listHTML += '<li class="'+_self.classes.noSuggestion.substring(1)+'">'+_self.settings.noSuggestionMsg+'</li>';
			}
			return listHTML;
		},

		addTag : function(value, animate=true) {

			if(!value) {
                return;
			}
			// Trim value
			if (typeof value === "string" && this.settings.trimValue) {
				value = $.trim(value);
			}
			
			// lowercase and dash
			if (typeof value === "string" && this.settings.lowercase && this.settings.dashspaces) {
				value = value.replace(/\s+/g, '-').toLowerCase();
			}
			else if (typeof value === "string" && this.settings.lowercase){
				value = value.toLowerCase();
			}
			else if (typeof value === "string" && this.settings.dashspaces){
				value = value.replace(/\s+/g, '-');
			}

			var html = '<span class="'+this.classes.tagItem.substring(1)+'" data-val="'+value+'">'+this.getTag(value)+' '+this.setIcon()+'</span>';
			$item    = $(html).insertBefore($(this.selectors.sTagsInput));
			if(this.settings.defaultTagClass) {
				$item.addClass(this.settings.defaultTagClass);
			}
			if(this.settings.tagLimit != -1 && this.settings.tagLimit > 0 && this.tagNames.length >= this.settings.tagLimit) {
				this.animateRemove($item, animate);
				if(animate) {
					this.flashItem(value);
				}
				return false;
			}
			var itemKey = this.getItemKey(value);
			if(this.settings.whiteList && itemKey === -1) {
				this.animateRemove($item, animate);
				if(animate) {
					this.flashItem(value, itemKey);
				}
				return false;
			}
			if(this.isPresent(value)) {
				this.animateRemove($item, animate);
				if(animate) {
					this.flashItem(value, itemKey);
				}
			} else {
				this.customStylings($item, itemKey);
				var dataVal = value;
				if($.isNumeric(dataVal)) {
					dataVal = (value.toString().indexOf('.') == -1)? parseInt(dataVal): parseFloat(dataVal);
				}
				this.tagNames.push(dataVal);
				this.setRemoveEvent();
				this.setInputValue();
				if(this.settings.afterAdd && typeof this.settings.afterAdd == "function") {
					this.settings.afterAdd(value);
				}
			}
			$(this.selector).trigger('suggestags.add', [value]);
			$(this.selector).trigger('suggestags.change');
			if(this.settings.triggerChange) {
				$(this.selector).trigger('change');
			}
			$(this.selectors.listArea).find(this.classes.listItem).removeClass('active');
			$(this.selectors.listArea).hide();
			$(this.selectors.sTagsInput).removeClass(this.classes.readyToRemove.substring(1));
			this.checkPlusAfter();

			if (this.settings.callback !== undefined){
			    this.settings.callback(value, 'highlight');
			}
		},

		getItemKey : function(value) {
			var itemKey = -1
			var _self = this;
			if(this.settings.suggestions.length) {
				var lower = value.toString().toLowerCase();
				$.each(this.settings.suggestions, function(key, item){
					if(typeof item === 'object') {
						if(item.value.toString().toLowerCase() == lower) {
							itemKey = key;
							if(item.class !== undefined && _self.settings.classes[key] === undefined) {
								_self.settings.classes[key] = item.class;
							}
							if(item.background !== undefined && _self.settings.backgrounds[key] === undefined) {
								_self.settings.backgrounds[key] = item.background;
							}
							if(item.color !== undefined && _self.settings.colors[key] === undefined) {
								_self.settings.colors[key] = item.color;
							}
							return false;
						}  
					} else if(item.toString().toLowerCase() == lower) {
						itemKey = key;
						return false;
					}
				});
			}
			return itemKey;
		},

		isPresent : function(value) {
			var present = false;
			$.each(this.tagNames, function(index, tag){
				if(value.toString().toLowerCase() == tag.toString().toLowerCase()) {
					present = true;
					return false;
				}
			});
			return present;
		},

		customStylings : function(item, key) {
			var isCustom = false;
			if(this.settings.classes[key]) {
				isCustom = true;
				$(item).addClass(this.settings.classes[key]);
			}
			if(this.settings.backgrounds[key]) {
				isCustom = true;
				$(item).css('background', this.settings.backgrounds[key]);
			}
			if(this.settings.colors[key]) {
				isCustom = true;
				$(item).css('color', this.settings.colors[key]);
			}
			if(!isCustom) {
                $(item).addClass(this.classes.colBg.substring(1));
            }
		},

		removeTag: function(value, animate=true) {
			var _self = this;
			$findTags = $(this.selectors.inputArea).find('[data-val="'+value+'"]');
			if($findTags.length) {
				$findTags.each(function(){
					_self.removeTagByItem(this, animate);


				});
			}
		},

		removeTagByItem : function(item, animate) {

			this.tagNames.splice($(item).index(), 1);
			this.animateRemove(item, animate);
			this.setInputValue();
			$(this.selector).trigger('suggestags.remove', [$(item).attr('data-val')]);
			$(this.selector).trigger('suggestags.change');
			if(this.settings.triggerChange) {
				$(this.selector).trigger('change');
			}
			if(this.settings.afterRemove && typeof this.settings.afterRemove == "function") {
				this.settings.afterRemove($(item).attr('data-val'));
			}
			$(this.selectors.sTagsInput).removeClass(this.classes.readyToRemove.substring(1));
			this.checkPlusAfter();
            if (this.settings.callback !== undefined){
			    this.settings.callback($(item).attr('data-val'), 'suppress');
			}
		},

		animateRemove : function(item, animate) {
			$(item).addClass('disabled');
			if(animate) {
				setTimeout(function(){
					$(item).slideUp();
					setTimeout(function(){
						$(item).remove();
					}, 500);
				}, 500);
			} else {
				$(item).remove();
			}
		},

		flashItem : function(value, itemKey) {
			$tagItem = '';
			value 	 = value.toString().toLowerCase();
			$(this.selectors.sTagsArea).find(this.classes.tagItem).each(function(){
				var tagName = $.trim($(this).attr('data-val'));
				if(value == tagName.toString().toLowerCase()) {
					$tagItem = $(this);
					return false;
				}
			});
			if($tagItem) {
				background = (this.settings.backgrounds[itemKey] !== undefined)? this.settings.backgrounds[itemKey]: null;
				if(background !== null) {
					$tagItem.css('background', ''); 
				}
				$tagItem.addClass('flash');
				setTimeout(function(){
					$tagItem.removeClass('flash');
					if(background !== null) {
						$tagItem.css('background', background);
					}
				}, 1500, $tagItem);
			}
		},

		setIcon : function() {
			var removeClass = this.classes.removeTag.substring(1);
			if(this.settings.type == 'bootstrap') {
				return '<span class="fa fa-times '+removeClass+'"></span>';
			} else if(this.settings.type == 'materialize') {
				return '<i class="material-icons right '+removeClass+'">clear</i>';
			} else {
				return '<b class="'+removeClass+'">&#10006;</b>';
			}
		},

		setInputValue: function() {
			this.updateIsRequired();
			$(this.selector).val(this.tagNames.join(','));
			if(this.settings.printValues) {
				this.printValues();
			}
		},

		fixCSS : function() {
			if(this.settings.type == 'amsify') {
				$(this.selectors.inputArea).addClass(this.classes.inputAreaDef.substring(1)).css({'padding': '5px 5px'});
			} else if(this.settings.type == 'materialize') {
				$(this.selectors.inputArea).addClass(this.classes.inputAreaDef.substring(1)).css({'height': 'auto', 'padding': '5px 5px'});
				$(this.selectors.sTagsInput).css({'margin': '0', 'height': 'auto'});
			}
		},

		printValues : function() {
			//console.info(this.tagNames, $(this.selector).val());
		},

		checkMethod : function() {
			$findTags = $(this.selector).next(this.classes.sTagsArea);
			if($findTags.length) {
				$findTags.remove();
			}
			$(this.selector).show();
			if(typeof this.method !== undefined && this.method == 'destroy') {
				return false;
			} else {
				return true;
			}
		},

		refresh : function() {
			this._setMethod('refresh');
			this._init();
		},

		destroy : function() {
			this._setMethod('destroy');
			this._init();
		},

		getActionURL : function(urlString) {
			var URL = '';
			if(window !== undefined) {
				URL = window.location.protocol+'//'+window.location.host;
			}
			if(this.isAbsoluteURL(urlString)) {
				URL = urlString;
			} else {
				URL += '/'+urlString.replace(/^\/|\/$/g, '');
			}
			return URL;
		},

		isAbsoluteURL : function(urlString) {
			var regexURL = new RegExp('^(?:[a-z]+:)?//', 'i');
			return (regexURL.test(urlString))? true: false;
		},

		unique: function(list) {
			var result = [];
			var _self  = this;
			$.each(list, function(i, e) {
				if(typeof e === 'object') {
					if(!_self.objectInArray(e, result)) {
						result.push(e);
					}
				} else {
					if($.inArray(e, result) == -1) {
						result.push(e);
					}
				}
			});
			return result;
		},

		objectInArray : function(element, result) {
			if(result.length) {
				var present = false;
				$.each(result, function(i, e) {
					if(typeof e === 'object') {
						if(e.value == element.value) {
							present = true;
							return false;
						}
					} else {
						if(e == element.value) {
							present = true;
							return false;
						}
					}
				});
				return present;
			} else {
				return false;
			}
		},

		isSimilarText: function(str1, str2, perc) {
			if(!this.settings.checkSimilar) {
				return false;
			}
			var percent = this.similarity(str1, str2);
			return (percent*100 >= perc)? true: false;
		},

		similarity: function(s1, s2) {
			var longer = s1;
			var shorter = s2;
			if(s1.length < s2.length) {
				longer = s2;
				shorter = s1;
			}
			var longerLength = longer.length;
			if(longerLength == 0) {
				return 1.0;
			}
			return (longerLength - this.editDistance(longer, shorter))/parseFloat(longerLength);
		},

		editDistance: function(s1, s2) {
			s1 = s1.toLowerCase();
			s2 = s2.toLowerCase();
			var costs = new Array();
			for(var i = 0; i <= s1.length; i++) {
				var lastValue = i;
				for(var j = 0; j <= s2.length; j++) {
					if(i == 0) {
						costs[j] = j;
					} else {
						if(j > 0) {
							var newValue = costs[j-1];
							if(s1.charAt(i-1) != s2.charAt(j-1)) {
								newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
							}
							costs[j-1] = lastValue;
							lastValue  = newValue;
						}
					}
				}
				if(i > 0)
					costs[s2.length] = lastValue;
			}
			return costs[s2.length];
		},

		checkPlusAfter : function(fromBlur) {
			if(this.settings.showPlusAfter > 0) {
				if(this.tagNames.length > this.settings.showPlusAfter) {
					var _self 	   = this;
					var plusNumber = this.tagNames.length - this.settings.showPlusAfter;
					if(!this.selectors.plusTag) {
						var html  = '<span class="'+this.classes.plusItem.substring(1)+'"></span>';
						this.selectors.plusTag 	= $(html).appendTo(this.selectors.inputArea);
						$(this.selectors.plusTag).addClass(this.classes.showPlusBg.substring(1));
						/**
						 * Show input after focus on input area
						 */
						$(this.selectors.inputArea).click(function(){
							$(_self.selectors.sTagsInput).show();
						});
					}
					$(this.selectors.plusTag).text('+ '+plusNumber);
					$tagItems = $(this.selectors.inputArea).find(this.classes.tagItem);
					$tagItems.show();
					if($(this.selectors.inputArea).hasClass(this.classes.focus.substring(1))){
						$(this.selectors.plusTag).hide();
					} else {
						if(fromBlur && !this.blurTgItems) {
							this.blurTgItems = $tagItems;
							setTimeout(function(){
								if(_self.blurTgItems) {
									_self.blurTgItems.slice(_self.settings.showPlusAfter).hide();
								}
							}, 200);
						} else {
							this.blurTgItems = null;
							$tagItems.slice(this.settings.showPlusAfter).hide();
						}
						$(this.selectors.sTagsInput).hide();
						$(this.selectors.plusTag).show();
					}
				} else if(this.selectors.plusTag) {
					$(this.selectors.inputArea).find(this.classes.tagItem).show();
					$(this.selectors.plusTag).hide();
				}
			}
		}
	};

	$.fn.amsifySuggestags = function(options, method) {
		return this.each(function() {
			var amsifySuggestags = new AmsifySuggestags(this);
			amsifySuggestags._settings(options);
			amsifySuggestags._setMethod(method);
			amsifySuggestags._init();
		});
	};
}));</script>

  <link rel="stylesheet" href="amsify.suggestags.css">
  <style>
    .link-active{
       stroke:solid;
    }

    .link-inactive{
       stroke-dasharray: 5,5;
    }
  </style>
</head>
<body>
    <nav class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary bg-gradient">
      <div class="container-fluid">
        <a class="navbar-brand" href="https://github.com/flypipe/flypipe" target="_blank">Flypipe</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="https://github.com/flypipe/flypipe" target="_blank">Documentation</a>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                Actions
              </a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#">Raw Queries</a></li>
              </ul>
            </li>
          </ul>
          <form class="d-flex" role="search">
            <input id="jose" type="text" class="form-control" name="tags" value=""/>
          </form>
        </div>
      </div>
    </nav>

    <div class="text-center">
        <div class="row">
            <div class="col">
                <div class="canvas"></div>
            </div>
        </div>
    </div>

    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script>

    <!--Offcanvas-->
    <div class="offcanvas offcanvas-end" width="600" data-bs-scroll="true" tabindex="-1" id="offcanvas" aria-labelledby="offcanvasWithBothOptionsLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvas-title"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body" id="offcanvas-body"></div>
    </div>

    <!--data-->
    
        <script>
        var user_width = -1;
        var user_height = -1;
        var tags = ["t3", "t6", "model", "raw.table", "t8", "DataSource", "pyspark", "t2", "pandas_on_spark", "t1", "split", "Transformation", "t4", "pandas", "t7", "t5", "train"];
        var nodes = [{"name": "raw.table", "position": [1.0, 50.0], "active": true, "run_status": {"bg-class": "success", "bg-color": "#198754", "text": "ACTIVE"}, "type": {"shape": "circle", "bg-class": "danger", "bg-color": "#dc3545", "text": "pyspark"}, "node_type": "DataSource", "dependencies": [], "successors": ["t1", "t7"], "definition": {"description": "Spark table raw.table", "tags": ["raw.table", "pyspark", "DataSource"], "columns": []}}, {"name": "t1", "position": [2.0, 50.0], "active": true, "run_status": {"bg-class": "success", "bg-color": "#198754", "text": "ACTIVE"}, "type": {"shape": "circle", "bg-class": "danger", "bg-color": "#dc3545", "text": "pyspark"}, "node_type": "Transformation", "dependencies": ["raw.table"], "successors": ["t2", "t3", "t5", "t6"], "definition": {"description": "No description", "tags": ["t1", "pyspark", "Transformation"], "columns": [{"name": "col1", "type": "Decimal", "description": "No description"}, {"name": "col2", "type": "Decimal", "description": "No description"}, {"name": "col3", "type": "Decimal", "description": "No description"}]}}, {"name": "t2", "position": [3.0, 33.33], "active": false, "run_status": {"bg-class": "dark", "bg-color": "#212529", "text": "SKIPPED"}, "type": {"shape": "circle", "bg-class": "success", "bg-color": "#198754", "text": "pandas"}, "node_type": "Transformation", "dependencies": ["t1"], "successors": ["t4"], "definition": {"description": "No description", "tags": ["t2", "pandas", "Transformation"], "columns": [{"name": "col1", "type": "Integer", "description": "No description"}]}}, {"name": "t3", "position": [3.0, 66.67], "active": false, "run_status": {"bg-class": "dark", "bg-color": "#212529", "text": "SKIPPED"}, "type": {"shape": "circle", "bg-class": "success", "bg-color": "#198754", "text": "pandas"}, "node_type": "Transformation", "dependencies": ["t1"], "successors": ["t4"], "definition": {"description": "No description", "tags": ["t3", "pandas", "Transformation"], "columns": [{"name": "col2", "type": "Integer", "description": "No description"}]}}, {"name": "t4", "position": [4.0, 50.0], "active": false, "run_status": {"bg-class": "dark", "bg-color": "#212529", "text": "SKIPPED"}, "type": {"shape": "circle", "bg-class": "success", "bg-color": "#198754", "text": "pandas"}, "node_type": "Transformation", "dependencies": ["t2", "t3"], "successors": ["t5", "t8"], "definition": {"description": "No description", "tags": ["t4", "pandas", "Transformation", "model", "split"], "columns": [{"name": "col1", "type": "Integer", "description": "No description"}]}}, {"name": "t5", "position": [5.0, 25.0], "active": true, "run_status": {"bg-class": "success", "bg-color": "#198754", "text": "ACTIVE"}, "type": {"shape": "circle", "bg-class": "success", "bg-color": "#198754", "text": "pandas"}, "node_type": "Transformation", "dependencies": ["t1", "t4"], "successors": ["t8"], "definition": {"description": "No description", "tags": ["t5", "pandas", "Transformation", "model", "train"], "columns": [{"name": "col3", "type": "Integer", "description": "No description"}]}}, {"name": "t6", "position": [5.0, 50.0], "active": true, "run_status": {"bg-class": "success", "bg-color": "#198754", "text": "ACTIVE"}, "type": {"shape": "circle", "bg-class": "warning", "bg-color": "#ffc107", "text": "pandas_on_spark"}, "node_type": "Transformation", "dependencies": ["t1"], "successors": ["t8"], "definition": {"description": "No description", "tags": ["t6", "pandas_on_spark", "Transformation"], "columns": [{"name": "col4", "type": "Integer", "description": "No description"}]}}, {"name": "t7", "position": [5.0, 75.0], "active": true, "run_status": {"bg-class": "success", "bg-color": "#198754", "text": "ACTIVE"}, "type": {"shape": "circle", "bg-class": "danger", "bg-color": "#dc3545", "text": "pyspark"}, "node_type": "Transformation", "dependencies": ["raw.table"], "successors": ["t8"], "definition": {"description": "No description", "tags": ["t7", "pyspark", "Transformation"], "columns": [{"name": "col2", "type": "Decimal", "description": "No description"}]}}, {"name": "t8", "position": [6.0, 50.0], "active": true, "run_status": {"bg-class": "success", "bg-color": "#198754", "text": "ACTIVE"}, "type": {"shape": "circle", "bg-class": "success", "bg-color": "#198754", "text": "pandas"}, "node_type": "Transformation", "dependencies": ["t4", "t5", "t6", "t7"], "successors": [], "definition": {"description": "No description", "tags": ["t8", "pandas", "Transformation"], "columns": [{"name": "col1", "type": "Integer", "description": "No description"}]}}];
        var links = [{"source": "t4", "source_position": [4.0, 50.0], "source_selected_columns": ["col1"], "target": "t8", "target_position": [6.0, 50.0], "active": true}, {"source": "t4", "source_position": [4.0, 50.0], "source_selected_columns": ["col1"], "target": "t5", "target_position": [5.0, 25.0], "active": true}, {"source": "t2", "source_position": [3.0, 33.33], "source_selected_columns": ["col1"], "target": "t4", "target_position": [4.0, 50.0], "active": false}, {"source": "t1", "source_position": [2.0, 50.0], "source_selected_columns": ["col1", "col3"], "target": "t2", "target_position": [3.0, 33.33], "active": false}, {"source": "t1", "source_position": [2.0, 50.0], "source_selected_columns": ["col2"], "target": "t3", "target_position": [3.0, 66.67], "active": false}, {"source": "t1", "source_position": [2.0, 50.0], "source_selected_columns": ["col2"], "target": "t5", "target_position": [5.0, 25.0], "active": true}, {"source": "t1", "source_position": [2.0, 50.0], "source_selected_columns": ["col2"], "target": "t6", "target_position": [5.0, 50.0], "active": true}, {"source": "raw.table", "source_position": [1.0, 50.0], "source_selected_columns": ["col1", "col2", "col3", "col5"], "target": "t1", "target_position": [2.0, 50.0], "active": true}, {"source": "raw.table", "source_position": [1.0, 50.0], "source_selected_columns": ["col1", "col2", "col3", "col4", "col5"], "target": "t7", "target_position": [5.0, 75.0], "active": true}, {"source": "t3", "source_position": [3.0, 66.67], "source_selected_columns": ["col2"], "target": "t4", "target_position": [4.0, 50.0], "active": false}, {"source": "t5", "source_position": [5.0, 25.0], "source_selected_columns": ["col2"], "target": "t8", "target_position": [6.0, 50.0], "active": true}, {"source": "t6", "source_position": [5.0, 50.0], "source_selected_columns": ["col4"], "target": "t8", "target_position": [6.0, 50.0], "active": true}, {"source": "t7", "source_position": [5.0, 75.0], "source_selected_columns": ["col2"], "target": "t8", "target_position": [6.0, 50.0], "active": true}];
        </script>
        

    <!--d3js-->
    <script>// Settings
function getWidth() {
  return Math.max(
    user_width,
    document.body.scrollWidth,
    document.documentElement.scrollWidth,
    document.body.offsetWidth,
    document.documentElement.offsetWidth,
    document.documentElement.clientWidth
  );
}

function getHeight() {
  return Math.max(
    user_height,
    document.body.scrollHeight,
    document.documentElement.scrollHeight,
    document.body.offsetHeight,
    document.documentElement.offsetHeight,
    document.documentElement.clientHeight
  );
}

function get_link(source_name, target_name){
    for (let i = 0; i < links.length; i++) {
        link = links[i];
        if (link.source == source_name & link.target == target_name){
            return link
        }
    }
}

const view_port_width = getWidth();
const view_port_height = getHeight();
const link_color = "#999";
const highlight_color = "black";
const circle_radius = 6;
const font_size = 16;
const stroke_width = 10;
const circle_stroke = 1;

// Setting Canvas and SVG
const canvas = d3.select(".canvas");

const svg = canvas.append('svg')
                  .attr('height', view_port_height)
                  .attr('width', view_port_width)
                  .attr("class","bg-light");

var g = svg.append("g");

const dragged_link_gen = d3.linkHorizontal()
            .source(d => d.source)
            .target(d => d.target)
            .x(d => d[0] - circle_radius + 3)
            .y(d => d[1]);



//x and y scales
var xScale = d3.scaleLinear().domain([d3.min(nodes, d => d.position[0]), d3.max(nodes, d => d.position[0])]).range([100, view_port_width * 0.9]);
var yScale = d3.scaleLinear().domain([d3.min(nodes, d => d.position[1]), d3.max(nodes, d => d.position[1])]).range([100, view_port_height * 0.9]);

function node_id(id){ return "node-" + id.replace('.', '-'); }
function link_id(source_id, target_id){ return source_id.replace('.', '-') + "-" + target_id.replace('.', '-'); }
function text_id(id){ return "text-" + id.replace('.', '-'); }

// Our link generator with the new .x() and .y() definitions
var linkGen = d3.linkHorizontal()
    .source(d => d.source_position)
    .target(d => d.target_position)
    .x(d => xScale(d[0]) - circle_radius + 3)
    .y(d => yScale(d[1]));

// Adding the links
d3.select("g")
      .selectAll("path.horizontal")
      .data(links)
      .enter()
      .append("path")
      .attr("d", linkGen)
      .attr("fill", "none")
      .attr("stroke", link_color)
      .attr("source", d => d.source)
      .attr("target", d => d.target)
      .attr('marker-end','url(#arrowhead)')
      .attr("id", d => link_id(d.source, d.target))
      .attr("class", function(d) {
        if (d.active) {
            return "link link-active";
        }
        else{
            return "link link-inactive";
        }
    });

// Adding Markers
d3.select("svg")
    .append('defs')
    .append('marker')
    .attr('id', 'arrowhead')
    .attr('viewBox', '-0 -5 10 10')
    .attr('refX', 13)
    .attr('refY', 0)
    .attr('orient', 'auto')
    .attr('markerWidth', 10)
    .attr('markerHeight', 10)
    .attr('xoverflow', 'visible')
    .attr('fill', link_color)
    .style('stroke','none')
    .attr("stroke-width", stroke_width)
    .append('path')
    .attr('d', 'M 0,-5 L 10 ,0 L 0,5')
    ;

// Adding the circle nodes
d3.select("g")
    .selectAll("path.horizontal")
    .data(nodes)
    .enter()
    .append("circle")
    .attr("cx", d => xScale(d.position[0]))
    .attr("cy", d => yScale(d.position[1]))
    .attr("r", circle_radius + "px")
    .attr("id", d => node_id(d.name))
    .attr("name", d => d.name)
    .attr("fill", d => d.type['bg-color'])
    .attr("cursor", "pointer")
    .style("stroke", "black")
    .style("stroke-width", circle_stroke)
    .call(d3.drag()
        .on('start', dragStart)
        .on('drag', dragging)
        .on('end', dragEnd)
      )
    .on('mouseover', function (d, i) { highlight_path(d,i); })
    .on('mouseout', function (d, i) { suppress(d,i); })
    .on('click', function(d,i){ show_transformation(d);  });


// Adding the text nodes
d3.select("g")
  .selectAll("path.horizontal")
  .data(nodes)
  .enter()
  .append("text")
  .attr("font-size", font_size + "px")
  .attr("text-anchor", "left")
  .attr("id", d => text_id(d.name))
  .attr("x", function(d) {
        return xScale(d.position[0]) - circle_radius;
        })
  .attr("y", function(d) {
        return yScale(d.position[1]) - circle_radius - 5;
        })
  .text(d => d.name)
    ;

var zoom = d3.zoom()
      .scaleExtent([0, 8])
      .on('zoom', function() {
          g.attr('transform', d3.event.transform);
});

svg.call(zoom);


function suppress(d,i){
    d3.selectAll('path.link')
      .filter(function(d_, i) {
        return d_['source'] == d['name'] | d_['target'] == d['name'];
      })
      .attr("stroke", link_color);
}

function highlight_path(d,i){

    d3.selectAll('path.link')
      .filter(function(d_, i) {
        return d_['source'] == d['name'] | d_['target'] == d['name'];;
      })
      .attr("stroke", highlight_color);
}

function move_parent_links(d, dragged_node){

    // move parent links
    d3.selectAll('path.link')
      .filter(function(d_, i) {
        return d_['source'] == d['name'] | d_['target'] == d['name'];
      })
      .attr("d", function(d_) {

        if (d_['source'] == d['name']){
            var source_node = d3.select("#" + node_id(d_.target));
            var data = {
            'target': [source_node.attr('cx') * 1, source_node.attr('cy') * 1],
            'source': [dragged_node.attr('cx') * 1, dragged_node.attr('cy') * 1],
            };
            return dragged_link_gen(data);
        }
        else {
            var source_node = d3.select("#" + node_id(d_.source));
            var data = {
            'source': [source_node.attr('cx') * 1, source_node.attr('cy') * 1],
            'target': [dragged_node.attr('cx') * 1, dragged_node.attr('cy') * 1],
            };
            return dragged_link_gen(data);
        }

      });

}

function dragging(d,i,nodes){

    //move Node
    var dragged_node = d3.select(nodes[i])
      .attr("cx", d3.event.x)
      .attr("cy", d3.event.y)
      ;

    //move text
    d3.select("#" + text_id(dragged_node.attr('name')))
        .attr("x", dragged_node.attr('cx') * 1  - circle_radius)
        .attr("y", dragged_node.attr('cy') * 1  - circle_radius - 5);

    //move link
    move_parent_links(d, dragged_node)

}

function dragStart(d,i,nodes){
    return
}

function dragEnd(d,i,nodes){
    return
}

let highlighted_nodes = new Set();
function suppress_nodes(){
    for (let i = 0; i < nodes.length; i++) {
        node = nodes[i];
        suppress_node(node.name);
    }
}

function suppress_node(node_name){
    highlighted_nodes.delete(node_name);
    d3.select("#" + node_id(node_name))
    .style("stroke-width", circle_stroke)
    .attr("r", circle_radius);

}

function highlight_node(node_name){
    d3.select("#" + node_id(node_name))
    .style("stroke-width", circle_stroke+1)
    highlighted_nodes.add(node_name);

    d3.select("#" + node_id(node_name))
            .attr('opacity',1)
            .attr("r", circle_radius)
            .transition()
            .duration(350)
            .attr('opacity',0)
            .attr("r", circle_radius * 10)
            .on('end',function(d) { blink(d.name, 0);});

}

//blink
function blink(node_name, o) {
    if (highlighted_nodes.has(node_name)){
        d3.select("#" + node_id(node_name))
            .attr('opacity',o)
            .attr("r", circle_radius)
            .transition()
            .duration(100)
            .attr('opacity',(o == 0.5? 1 : 0.5))
            .on('end',function(d) { blink(d.name, (o == 0.5? 1 : 0.5));});
    }
    else {
        d3.select("#" + node_id(node_name)).attr('opacity',1);
    }
};</script>

    <!--offcanvas-->
    <script>const bsOffcanvas = new bootstrap.Offcanvas('#offcanvas', {
    backdrop: true,
    scroll: true,
    keyboard: true,
})

const offcanvasTitle = document.getElementById('offcanvas-title');
const offcanvasBody = document.getElementById('offcanvas-body');

function show_offcanvas(title, body){
    offcanvasTitle.innerHTML = title;
    offcanvasBody.innerHTML = body;
    bsOffcanvas.show();
}

function show_transformation(node){

    if (typeof node === 'string' || node instanceof String) {
        for (let i = 0; i < nodes.length; i++) {
            if (nodes[i].name == node){
                node = nodes[i];
                break;
            }
        }
    }

    title = node.node_type;

    body = "<h5 class='mb-4'>" + node.name + "</h5>";
    body += '<p class="text-break fw-lighter font-monospace mb-5">' +
                node.definition.description +
           '</p>';

    body += "<h5 class='mt-5 mb-3'>Tags</h5>";
    for (let i = 0; i < node.definition.tags.length; i++) {
        body += "<span class='badge text-bg-light mr-3'>" + node.definition.tags[i] + "</span>";
    }

    body += "<h5 class='mt-5 mb-3'>Transformation</h5>";
    body += '<ul class="list-unstyled">';
    body += '<li class="list-group-item">Type' + '<span class="badge text-bg-' + node.type['bg-class'] + ' float-end">' + node.type['text'] + '</span></li>';
    body += '<li class="list-group-item">Status' + '<span class="badge text-bg-' + node.run_status['bg-class'] + ' float-end">' + node.run_status['text'] + '</span></li>';
    body += '</ul>';

    body += "<h5 class='mt-5 mb-3'>Dependencies</h5>";
    body += '<ul class="list-unstyled">';
    if (Object.keys(node.dependencies).length == 0){
        body += '<li class="list-group-item fst-italic">No dependencies</li>';
    }
    for (let i = 0; i < node.dependencies.length; i++) {
        dependency = node.dependencies[i];
        body += '<li class="list-group-item"><a href="#" class="link-dark" onclick="show_transformation(\'' + dependency + '\');">' + dependency + '</a></li>';
        link = get_link(dependency, node.name);
        for (let i = 0; i < link.source_selected_columns.length; i++) {
            selected_column = link.source_selected_columns[i];
            body += '<li class="list-group-item"><span class="ms-3">' + selected_column + '</span></li>';
        }

    }

    body += '</ul>';

    body += "<h5 class='mt-5 mb-3'>Successors</h5>";
    body += '<ul class="list-unstyled">';
    if (node.successors.length == 0){
        body += '<li class="list-group-item fst-italic">No successors</li>';
    }
    for (let i = 0; i < node.successors.length; i++) {
        successor = node.successors[i];
        body += '<li class="list-group-item"><a href="#" class="link-dark" onclick="show_transformation(\'' + successor + '\');">' + successor + '</a></li>';
    }
    body += '</ul>';

    if (node.definition.columns.length > 0){
        body += "<h5 class='mt-5 mb-3'>Output Schema</h5>";
    }
    for (let i = 0; i < node.definition.columns.length; i++) {
        column = node.definition.columns[i];
        body += '<p class="fw-bold text-start">' +
                    column.name +
                    '<span class="badge rounded-pill text-bg-secondary float-end">' + column.type + '</span>' +
                '</p>' +
                '<p class="fw-lighter font-monospace mb-5">' +
                column.description +
                '</p>';
    }

    show_offcanvas(title, body);
}</script>

    <!--tags-->
    <script>function action_tag(tag, action){
    console.log(tag, action);
    if (action == 'highlight') {
        for (let i = 0; i < nodes.length; i++) {
            node = nodes[i];
            if (node.definition.tags.includes(tag)){
                highlight_node(node.name);
            }
        }
    }
    else if (action == 'suppress') {
        still_selected_tags = $('input[name="tags"]').val().split(",");

        for (let i = 0; i < nodes.length; i++) {
            node = nodes[i];

            if (node.definition.tags.includes(tag) & highlighted_nodes.has(node.name)){

                still_contain_tag = (still_selected_tags.length > 0) ? false : true;

                for (let j = 0; j < still_selected_tags.length; j++) {
                    still_selected_tag = still_selected_tags[j];
                    if (node.definition.tags.includes(still_selected_tag)){
                        still_contain_tag = true;
                        break;
                    }
                }

                if (!still_contain_tag){
                    suppress_node(node.name);
                }


            }
        }
    }

}

ff = $('input[name="tags"]').amsifySuggestags({
    suggestions: tags,
    whiteList: true,
    defaultLabel: 'Filter tag',
    callback: action_tag
});
</script>
</body>
</html>
            